name: Build Terror Short

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 */2 * *"  # cada 2 días a las 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    env:
      OPENAI_TEXT_MODEL: gpt-4o-mini
      OPENAI_TTS_MODEL: gpt-4o-mini-tts
      OPENAI_TTS_VOICE: alloy

      # ===== NUEVO (TTS control sin tocar scripts) =====
      # 0 = final silencioso (NO narra CTA)
      # 1 = agrega story.cta al final del audio
      INCLUDE_CTA_AUDIO: "1"

      # 1 = pausas más cortas, 2 = pausas más naturales (recomendado)
      TTS_LINE_BREAKS: "2"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps + ffmpeg
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Generate story + B-roll + TTS + SRT + Render (DEBUG)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          set -e

          echo "========== DEBUG START =========="
          echo "PWD:" && pwd
          echo "ROOT CONTENTS (before):" && ls -la

          mkdir -p out

          echo "OPENAI_API_KEY length: ${#OPENAI_API_KEY}"
          echo "PEXELS_API_KEY length: ${#PEXELS_API_KEY}"
          test ${#OPENAI_API_KEY} -gt 20
          test ${#PEXELS_API_KEY} -gt 20

          case "$OPENAI_API_KEY" in
            sk-*|sk-proj-*) echo "OpenAI key looks OK" ;;
            *) echo "ERROR: OPENAI_API_KEY does not look like an OpenAI key"; exit 1 ;;
          esac

          echo "TTS SETTINGS:"
          echo "INCLUDE_CTA_AUDIO=${INCLUDE_CTA_AUDIO}"
          echo "TTS_LINE_BREAKS=${TTS_LINE_BREAKS}"

          echo "========== generate_story.py =========="
          python scripts/generate_story.py
          echo "FIND story.json:" && find . -maxdepth 4 -type f -name "story.json" -print

          echo "========== download_broll.py =========="
          python scripts/download_broll.py
          echo "BROLL CONTENTS:" && ls -la out/broll || true

          echo "========== tts_openai.py =========="
          python scripts/tts_openai.py
          echo "FIND voice.mp3:" && find . -maxdepth 4 -type f -name "voice.mp3" -print

          echo "========== make_srt.py =========="
          python scripts/make_srt.py
          echo "FIND subs.srt:" && find . -maxdepth 4 -type f -name "subs.srt" -print

          echo "========== detect audio duration =========="
          export DURATION=$(ffprobe -v error -show_entries format=duration \
            -of default=nk=1:nw=1 voice.mp3 | awk '{print int($1+0.5)}')
          echo "Detected DURATION=${DURATION}s"

          echo "========== render.sh =========="
          bash scripts/render.sh
          echo "FIND final.mp4:" && find . -maxdepth 4 -type f -name "final.mp4" -print

          echo "========== move outputs to out/ =========="
          [ -f story.json ] && mv story.json out/ || true
          [ -f voice.mp3 ] && mv voice.mp3 out/ || true
          [ -f subs.srt ] && mv subs.srt out/ || true
          [ -f final.mp4 ] && mv final.mp4 out/ || true

          echo "OUT CONTENTS:" && ls -la out || true
          echo "========== DEBUG END =========="

          test -f out/final.mp4

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: terror-short
          path: out/
