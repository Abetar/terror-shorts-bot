name: Build Terror Short

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 */2 * *"  # cada 2 días a las 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OPENAI_TEXT_MODEL: gpt-4o-mini
      OPENAI_TTS_MODEL: gpt-4o-mini-tts
      OPENAI_TTS_VOICE: alloy
      DURATION: "72"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps + ffmpeg
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Generate story + TTS + SRT + Render
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          mkdir -p out

          python scripts/generate_story.py
          python scripts/tts_openai.py
          python scripts/make_srt.py
          bash scripts/render.sh

          # Mueve outputs a out/ (por si se generaron en raíz)
          [ -f story.json ] && mv story.json out/ || true
          [ -f voice.mp3 ] && mv voice.mp3 out/ || true
          [ -f subs.srt ] && mv subs.srt out/ || true
          [ -f final.mp4 ] && mv final.mp4 out/ || true

          echo "== OUT CONTENTS =="
          ls -la out || true

          # Falla si no existe el resultado final
          test -f out/final.mp4

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: terror-short
          path: out/
