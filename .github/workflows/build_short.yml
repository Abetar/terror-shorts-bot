name: Build Terror Short

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 */2 * *"  # cada 2 d√≠as a las 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OPENAI_TEXT_MODEL: gpt-4o-mini
      OPENAI_TTS_MODEL: gpt-4o-mini-tts
      OPENAI_TTS_VOICE: alloy
      DURATION: "72"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps + ffmpeg
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Generate story + TTS + SRT + Render (DEBUG)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e

          echo "========== DEBUG START =========="
          echo "PWD:"
          pwd

          echo "ROOT CONTENTS (before):"
          ls -la

          mkdir -p out

          echo "========== generate_story.py =========="
          python scripts/generate_story.py
          echo "ROOT CONTENTS (after story):"
          ls -la
          echo "FIND story.json:"
          find . -maxdepth 4 -type f -name "story.json" -print

          echo "========== tts_openai.py =========="
          python scripts/tts_openai.py
          echo "ROOT CONTENTS (after tts):"
          ls -la
          echo "FIND voice.mp3:"
          find . -maxdepth 4 -type f -name "voice.mp3" -print

          echo "========== make_srt.py =========="
          python scripts/make_srt.py
          echo "ROOT CONTENTS (after srt):"
          ls -la
          echo "FIND subs.srt:"
          find . -maxdepth 4 -type f -name "subs.srt" -print

          echo "========== render.sh =========="
          bash scripts/render.sh
          echo "ROOT CONTENTS (after render):"
          ls -la
          echo "FIND final.mp4:"
          find . -maxdepth 4 -type f -name "final.mp4" -print

          echo "========== move outputs to out/ =========="
          [ -f story.json ] && mv story.json out/ || true
          [ -f voice.mp3 ] && mv voice.mp3 out/ || true
          [ -f subs.srt ] && mv subs.srt out/ || true
          [ -f final.mp4 ] && mv final.mp4 out/ || true

          echo "OUT CONTENTS:"
          ls -la out || true

          echo "========== DEBUG END =========="

          # Fuerza fallo si no existe el resultado final
          test -f out/final.mp4

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: terror-short
          path: out/
